<!DOCTYPE>
<html>

<head>
    <title>JSON EDITOR</title>
    <meta charset="utf-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #header {
            background-color: #3883fa;
        }
        
        b,
        strong {
            font-weight: normal;
        }
        
        cite,
        em {
            font-style: normal;
        }
        
        #header ul {
            margin: 0 20px;
            height: 48px;
        }
        
        #tree {
            margin: 0 20px;
            height: 100%;
        }
        
        ul li {
            float: left;
            list-style: none;
            height: 48px;
            line-height: 48px;
        }
        
        ul li:first-child {
            margin-right: 300px;
        }
        
        ul li:first-child button {
            margin-left: 20px;
        }
        
        ul li button,
        select {
            cursor: pointer;
            border-radius: 4px;
            margin-right: 20px;
            padding: 0 10px;
            color: #999;
        }
        
        #tree {
            padding-left: 20px;
            position: relative;
            outline: none;
        }
        
        i {
            cursor: pointer;
            display: inline-block;
            width: 0px;
            height: 0px;
            border-style: solid;
            border-width: 4px;
            /* position: absolute;
            left: 6px; */
        }
        
        .triangle_border_right {
            border-color: transparent transparent transparent #333;
        }
        
        .triangle_border_down {
            border-color: #333 transparent transparent transparent;
        }
        
        .boolean {
            color: #ff0000;
        }
        
        .bracket {
            color: grey;
        }
        
        .number {
            color: green;
        }
        
        .string {
            color: #ff8c00
        }
        
        button,
        input {
            cursor: pointer;
            border: none;
            outline: none;
            background-color: white;
            widows: 21px;
            height: 21px;
            padding: 0px;
            vertical-align: middle;
        }
        
        dl {
            margin: 4px;
        }
        
        dd {
            margin-left: 20px;
        }
        
        dt {
            /* font-size: 0; */
        }
    </style>
</head>

<body>

    <div id="header">
        <ul>
            <li>
                <label for="file">Upload a JSON file ：</label>
                <input type="file" name="file" id="fileId" />
                <button type="submit" name="btn" value="提交" id="btnId" onclick="check()" /> Upload</button>
            </li>
            <li>
                <select name="" id="selectMethod">
                    <option value="1">tree</option>
                    <option value="0">code</option>
                </select>
            </li>
            <li id="formatTree"><button>Formatting</button></li>
            <li id="clear_txt"><button>Clear</button></li>
            <li id="save_as"><button>Save</button></li>
        </ul>
    </div>
    <div id="tree" contenteditable="true"></div>


    <!-- <textarea name="" id="json_eidit" cols="30" rows="10"></textarea> -->
    <div id="json_editInfo">JSONin</div>
    <div id="update">刷新</div>
    <div id="format_indent">缩进</div>
    <script type="text/javascript">
        window.onload = function() {
            var $ = function(id) {
                return document.getElementById(id)
            };
            /* 关联UI */
            JE.editUI = $("json_eidit");
            JE.msgUI = $("json_editInfo");
            JE.treeUI = $("tree");
            var saveJson = $("save_as");
            var selectMethod = $("selectMethod");
            var clearTree = $("clear_txt");
            var formatTree = $("formatTree");

            var obj = {
                "array1": [{
                    "a": "1"
                }, {
                    "b": "2"
                }],
                "array": [
                    1,
                    2,
                    3
                ],
                "boolean": true,
                "null": null,
                "number": 123,
                "object": {
                    "a": "b",
                    "c": "d"
                }
            }



            function getTreeContent() {
                var treeText = document.getElementById("tree").innerText;
                if (/^\s*$/.test(treeText)) return JE.msg('请输入JSON格式的代码!');
                try {
                    /*去除空格和换行符号*/
                    treeText = treeText.replace(/\ +/g, '').replace(/[\r\n]/g, '').replace(/\s|\xA0/g, "");
                    JE.data = JSON.parse(treeText);
                } catch (e) {
                    console.log(e)
                    return JE.msg("源代码有错误: " + e.description + ' , 如果正在编辑中, 请忽略此消息!', 'err');
                };
                return true;
            }
            saveJson.onclick = function() {
                if (getTreeContent()) {
                    var datastr = "data:json;charset=utf-8," + encodeURIComponent(JSON.stringify(JE.data));
                    var downloadAnchorNode = document.createElement('a')
                    downloadAnchorNode.setAttribute("href", datastr);
                    downloadAnchorNode.setAttribute("download", 'new.json')
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                }
            }
            clearTree.onclick = function() {
                JE.treeUI.innerHTML = "";
            }
            formatTree.onclick = function() {
                formatJson();
            }
            selectMethod.onchange = function() {
                formatJson();
            }
            var formatJson = function(compress) {
                if (selectMethod.value == 0) {
                    if (getTreeContent()) {
                        var str = JSON.stringify(JE.data, undefined, 4);
                        JE.treeUI.innerHTML = "<pre>" + str + "</pre>";
                    }
                } else {
                    if (getTreeContent()) {
                        JE.msg('语法正确,正在重新构造树,请稍候...', 'busy');
                        JE.toTree();
                    }
                }
            }
        }

        function show() {
            var dl = document.getElementById(event.target.id.split("_")[0] + "_dl");
            var i = document.getElementById(event.target.id.split("_")[0] + "_i")
            var eData = event.target.getAttribute("data")
            if (eData.split("_")[1] == "1") {
                event.target.setAttribute("data", eData.split("_")[0] + "_0");
                dl.childNodes[1].style.display = "none";
                i.setAttribute("class", "triangle_border_right");
            } else {
                event.target.setAttribute("data",
                    eData.split("_")[0] + "_1");
                dl.childNodes[1].style.display = "block";
                i.setAttribute("class", "triangle_border_down");
            }
        }

        function check() {
            var objFile = document.getElementById("fileId");
            var data = null;
            var files = objFile.files; //获取到文件列表
            if (files.length == 0) {
                alert('请选择文件');
            } else {
                var reader = new FileReader(); //新建一个FileReader
                reader.readAsText(files[0], "UTF-8"); //读取文件 
                reader.onload = function(evt) { //读取完文件之后会回来这里
                    data = evt.target.result; // 读取文件内容
                    /*Remove annotation */
                    var reg = /("([^\\\"]*(\\.)?)*")|('([^\\\']*(\\.)?)*')|(\/{2,}.*?(\r|\n))|(\/\*(\n|.)*?\*\/)/g; // 正则表达式  
                    data = data.replace(reg, function(word) { // 去除注释后的文本  
                        return /^\/{2,}/.test(word) || /^\/\*/.test(word) ? "" : word;
                    });
                    JE.begin(data);
                }
                selectMethod.value = "1";
            }
        }
        JE = {
            data: {},
            /* 关联数据 */
            code: false,
            /* 格式化后的代码 */
            oldCode: [],
            /* 历史代码 */
            editUI: null,
            /* 关联编辑框 */
            msgUI: null,
            /* 信息显示窗口 */
            treeUI: null,
            /* 树窗口 */
            name: '',
            /* 实例名 */
            root: '',
            /* 根节点标题 */
            checkbox: 0,
            /* 是否添加复框 */
            hot: null,
            /* 选中节点 */
            indent: ' ',
            /*缩进符'\t'或者4个' '*/
            firstUp: true,
            /*第一次自动刷新*/
            onclick: Array,
            /*树点击通知*/
            countInfo: '',
            /*统计信息*/
            formating: false,
            /*行数*/
            number: 0,

            /* 格式化中(禁止重构树) */
            toTree: function() {
                /* JSON转换为树HTML,同时格式化代码 */
                var draw = [],
                    This = this;
                JE.firstUp = false; /*完成首次自动构造*/
                function notify(name /*节点名*/ , value /*节点值*/ , bool /*是否为最后一项*/ ) {

                    if (value && value.constructor == Array) {
                        /* 处理数组节点 */
                        This.number++;
                        draw.push('<dl id="' + This.number + '_dl"><dt>', This.draw(name, value), '</dt><dd>');

                        for (var i = 0; i < value.length; i++) {
                            i == value.length - 1 ? notify(i, value[i], true) : notify(i, value[i], false);
                        }
                        var bracket = bool ? "]" : "],"
                        draw.push('</dd><dt><span class="bracket">' + bracket + '</span></dt></dl>');
                    } else if (value && typeof value == 'object') {
                        /* 处理对象节点 */
                        This.number++;
                        draw.push('<dl id="' + This.number + '_dl"><dt>', This.draw(name, value), ' </dt><dd>');
                        var len = 0,
                            i = 0;
                        for (var key in value) {
                            /* 获取对象成员总数 */
                            len++;
                        }
                        for (var key in value) {
                            i++;
                            i == len ? notify(key, value[key], true) : notify(key, value[key], false);
                        }
                        var bracket = bool ? "}" : "},"
                        draw.push('</dd><dt><span class="bracket">' + bracket + '</span></dt></dl>');
                    } else {
                        /* 处理叶节点(绘制文件) */
                        draw.push('<dl><dt>', This.draw(name, value, bool), '</dt></dl>');
                    };
                };
                /* 不是[]或者{}不绘制 */

                if (typeof this.data == 'object') {
                    notify(this.root, this.data, true);
                };

                if (this.treeUI) this.treeUI.innerHTML = draw.join(''); /* 显示在树窗口 */ {
                    this.msg('成功构造树视图!');
                }
            },
            draw: function(name, value, bool /*是否为最后一项*/ ) {
                if (typeof name == "number") {
                    if (value && value.constructor == Array) return this.highlight('', value, "[", bool);
                    else return this.highlight("", value, "{", bool);
                } else if (typeof name == "string") {
                    if (value && value.constructor == Array) return this.highlight('"' + name + '"</b><em class="bracket"> : </em>', value, "[", bool);
                    else return name.length > 0 ?
                        this.highlight('"' + name + '"</b><em class="bracket"> : </em>', value, "{", bool) :
                        this.highlight('', value, "{", bool);
                }
            },
            highlight: function(nameStr, value, bracket, bool /*是否为最后一项*/ ) {
                if (typeof value != "string")
                    var valueStr = bool ? value : value + ",";
                switch (typeof value) {
                    case "boolean":
                        return '<b  class="string">' + nameStr + ' <strong class="boolean">' + valueStr + '</strong>'
                        break;
                    case "number":
                        return '<b  class="string">' + nameStr + ' <cite class="number">' + valueStr + '</cite>'
                        break;
                    case "string":
                        {
                            if (bool) return '<b  class="string">' + nameStr + '<b class ="string">"' + value + '"</b>';
                            else return '<b  class="string">' + nameStr + '<b class ="string">"' + value + '" ,</b>';
                            break;
                        }
                    case "object":
                        return '<button onclick="show()" id="' + this.number + '_btn" data="' + this.number + '_1">\
                                <i class="triangle_border_down"  id="' + this.number + '_i" data="' + this.number + '_1" ></i></button>\
                                <b class="string">' + nameStr + '<em class ="bracket">' + bracket + '</em>';
                }
            },
            format: function(txt, compress /*是否为压缩模式*/ ) { /* 格式化JSON源码(对象转换为JSON文本) */
                if (/^\s*$/.test(txt)) return this.msg('数据为空,无法格式化! ');
                try {
                    var data = eval('(' + txt + ')');
                } catch (e) {
                    // JE.editUI.style.color = 'red';
                    return this.msg('数据源语法错误,格式化失败! 错误信息: ' + e.description, 'err');
                };
                // JE.editUI.style.color = '#000';
                var draw = [],
                    last = false,
                    This = this,
                    line = compress ? '' : '\n',
                    nodeCount = 0,
                    maxDepth = 0;
                var notify = function(name, value, isLast, indent /*缩进*/ , formObj) {
                    nodeCount++; /*节点计数*/
                    for (var i = 0, tab = ''; i < indent; i++) tab += This.indent; /* 缩进HTML */
                    tab = compress ? '' : tab; /*压缩模式忽略缩进*/
                    maxDepth = ++indent; /*缩进递增并记录*/
                    if (value && value.constructor == Array) { /*处理数组*/
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + '[' + line); /*缩进'[' 然后换行*/
                        for (var i = 0; i < value.length; i++) {
                            notify(i, value[i], i == value.length - 1, indent, false);
                        }
                        draw.push(tab + ']' + (isLast ? line : (',' + line))); /*缩进']'换行,若非尾元素则添加逗号*/
                    } else if (value && typeof value == 'object') { /*处理对象*/
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + '{' + line); /*缩进'{' 然后换行*/
                        var len = 0,
                            i = 0;
                        for (var key in value) {
                            len++;
                        }
                        for (var key in value) {
                            notify(key, value[key], ++i == len, indent, true)
                        };
                        draw.push(tab + '}' + (isLast ? line : (',' + line))); /*缩进'}'换行,若非尾元素则添加逗号*/
                    } else {
                        if (typeof value == 'string') {
                            value = '"' + value + '"';
                        }
                        draw.push(tab + (formObj ? ('"' + name + '":') : '') + value + (isLast ? '' : ',') + line);
                    };
                };
                var isLast = true,
                    indent = 0;
                notify('', data, isLast, indent, false);
                this.countInfo = '共处理节点<b>' + nodeCount + '</b>个,最大树深为<b>' + maxDepth + '</b>';
                return draw.join('');
            },
            msg: function(text, type) {
                /* 编辑状态或者错误通知 */
                if (!this.msgUI) return alert(text);
                with(new Date) var now = ([getHours(), getMinutes(), getSeconds()].join(':')).replace(/\b\d\b/g, '0$&');
                this.msgUI.innerHTML = '<div>[' + now + ']   ' + text.replace(/\n/g, '<br/>') + '</div>';
                this.msgUI.className = type;
            }
        };
        JE.begin = function(data) { /* 设置UI控件关联响应 */
            var $ = function(id) {
                return document.getElementById(id)
            };
            /* 监听代码变化事件 */
            JE.initTree = function(data) {
                // if (JE.formating) return; /* 格式化不刷新树 */
                if (/^\s*$/.test(data)) return JE.msg('请输入JSON格式的代码!');
                try {
                    JE.data = JSON.parse(data);
                } catch (e) {
                    // JE.editUI.style.color = 'red';
                    console.log(e)
                    return JE.msg("源代码有错误: " + e.description + ' , 如果正在编辑中, 请忽略此消息!', 'err');
                };
                // JE.editUI.style.color = '#000';
                JE.msg('语法正确,正在重新构造树,请稍候...', 'busy');
                JE.toTree();
                JE.msg('语法正确,请点击刷新,或者打开视图同步开关,或者继续编辑!')
                    // }
                return true;
            };
            if (window.ActiveXObject)
                document.execCommand("BackgroundImageCache", false, true);
            JE.initTree(data);
        };
    </script>
</body>

</html>